<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE5ERS Trading Dashboard - Legacy System</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: #181c20;
            font-family: 'Montserrat', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            color: #e0e0e0;
        }
        .dashboard-header {
            background: linear-gradient(90deg, #23272f 60%, #1a1d22 100%);
            border-radius: 18px;
            margin-bottom: 24px;
            padding: 28px 20px 20px 20px;
            color: #fff;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.25);
        }
        .dashboard-title {
            font-size: 2.7rem;
            font-weight: 700;
            text-shadow: 0 2px 8px #00ffe7, 0 0px 2px #000;
            margin-bottom: 8px;
            letter-spacing: 1px;
        }
        .dashboard-subtitle {
            font-size: 1.15rem;
            opacity: 0.85;
            color: #b0b0b0;
        }
        .legacy-badge {
            background: linear-gradient(90deg, #ffb700 60%, #ff6f00 100%);
            color: #23272f;
            border-radius: 20px;
            padding: 4px 14px;
            font-size: 0.85rem;
            margin-left: 12px;
            font-weight: 600;
            box-shadow: 0 2px 8px #ffb70044;
        }
        .metric-card {
            background: rgba(32, 36, 40, 0.95);
            border-radius: 16px;
            padding: 22px 18px;
            margin-bottom: 22px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.18);
            border: 1px solid #23272f;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .metric-card:hover {
            transform: translateY(-4px) scale(1.01);
            box-shadow: 0 12px 40px #00ffe733;
        }
        .metric-value {
            font-size: 2.3rem;
            font-weight: bold;
            margin: 10px 0;
            color: #00ffe7;
            text-shadow: 0 2px 8px #00ffe7aa;
        }
        .metric-label {
            font-size: 1.05rem;
            color: #b0b0b0;
            margin-bottom: 5px;
            font-weight: 500;
        }
        .metric-change {
            font-size: 0.95rem;
            margin-top: 5px;
            color: #888;
        }
        .status-achieved { color: #00ffe7; }
        .status-pending { color: #ffb700; }
        .status-ok { color: #00ffe7; }
        .status-warning { color: #ffb700; }
        .status-critical { color: #ff3c3c; }
        .chart-container {
            background: rgba(32, 36, 40, 0.98);
            border-radius: 16px;
            padding: 20px 12px;
            margin-bottom: 22px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.18);
            border: 1px solid #23272f;
        }
        .compliance-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            margin: 5px;
            background: #23272f;
            color: #fff;
            border: 1px solid #00ffe7;
            box-shadow: 0 2px 8px #00ffe744;
        }
        .badge-achieved { background: #23272f; color: #00ffe7; border-color: #00ffe7; }
        .badge-pending { background: #23272f; color: #ffb700; border-color: #ffb700; }
        .badge-ok { background: #23272f; color: #00ffe7; border-color: #00ffe7; }
        .badge-warning { background: #23272f; color: #ffb700; border-color: #ffb700; }
        .badge-critical { background: #23272f; color: #ff3c3c; border-color: #ff3c3c; }
        .quantum-indicators {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
        }
        .quantum-indicator {
            text-align: center;
            padding: 10px;
            background: linear-gradient(90deg, #23272f 60%, #1a1d22 100%);
            border-radius: 10px;
            flex: 1;
            margin: 0 5px;
            color: #fff;
            box-shadow: 0 2px 8px #00ffe744;
        }
        .last-update {
            font-size: 0.85rem;
            color: #b0b0b0;
            text-align: center;
            margin-top: 10px;
        }
        .loading-spinner {
            text-align: center;
            padding: 20px;
            color: #00ffe7;
        }
        .profit-positive { color: #00ffe7; }
        .profit-negative { color: #ff3c3c; }
        .profit-neutral { color: #b0b0b0; }
        .refresh-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #23272f;
            border-radius: 50%;
            padding: 10px;
            box-shadow: 0 4px 16px #00ffe744;
            z-index: 1000;
            color: #00ffe7;
        }
        .refresh-indicator.active {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Neon button */
        .btn-primary {
            background: linear-gradient(90deg, #00ffe7 60%, #00bfff 100%);
            color: #23272f;
            border: none;
            font-weight: 600;
            box-shadow: 0 2px 8px #00ffe744;
            transition: background 0.2s, color 0.2s;
        }
        .btn-primary:hover {
            background: linear-gradient(90deg, #00bfff 60%, #00ffe7 100%);
            color: #181c20;
        }
        .btn-success {
            background: linear-gradient(90deg, #00ffe7 60%, #00bfff 100%);
            color: #23272f;
            border: none;
            font-weight: 600;
        }
        .btn-danger {
            background: linear-gradient(90deg, #ff3c3c 60%, #ffb700 100%);
            color: #23272f;
            border: none;
            font-weight: 600;
        }
        .btn {
            border-radius: 12px;
            font-size: 1rem;
            padding: 8px 18px;
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <div class="dashboard-header d-flex justify-content-between align-items-center">
            <div>
                <div class="dashboard-title">
                    <i class="fas fa-chart-line"></i> THE5ERS Trading Dashboard
                    <span class="legacy-badge">Legacy System</span>
                </div>
                <div class="dashboard-subtitle">
                    Real-time Quantum Trading Monitor - Legacy Configuration
                </div>
            </div>
            <div class="text-end">
                <div style="margin-bottom:8px; display: flex; gap: 10px; justify-content: flex-end; align-items: center;">
                    <span class="badge bg-{{ 'success' if compliance and compliance.target.status == 'achieved' else 'warning' }}" style="font-size:1rem; padding:8px 16px; border-radius:18px;">
                        <i class="fas fa-server"></i> MT5: {% if 'Connesso' in mt5_warning or 'non attiva' in mt5_warning or 'non connesso' in mt5_warning %} <span style="color:#ffb700;">OFFLINE</span> {% else %} <span style="color:#00ffe7;">ONLINE</span> {% endif %}
                    </span>
                    <a href="/" class="btn btn-success" style="font-size:1rem; padding:8px 18px;">
                        <i class="fas fa-home"></i> Torna alla Home
                    </a>
                </div>
                <form method="get" action="/dashboard" style="margin-top:8px;">
                    <button type="submit" class="btn btn-primary" style="font-size:1rem; padding:8px 18px;">
                        <i class="fas fa-sync-alt"></i> Refresh MT5
                    </button>
                </form>
            </div>
        </div>
        {{ mt5_warning|safe }}
        <div class="row">
            <div class="col-12">
                <div class="metric-card">
                    <h5><i class="fas fa-shield-alt"></i> THE5ERS Compliance Status</h5>
                    <div class="compliance-badge badge-{{ compliance.target.status }}">{{ compliance.target.message }}</div>
                    <div class="compliance-badge badge-{{ compliance.drawdown.status }}">{{ compliance.drawdown.message }}</div>
                </div>
            </div>
        </div>
        <hr style="border-top:2px solid #00ffe7; margin: 18px 0 24px 0; opacity:0.25;">
        <div class="row">
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-label"><i class="fas fa-target"></i> Profit Percentage</div>
                    <div class="metric-value">{{ metrics.profit_percentage|round(2) }}%</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-label"><i class="fas fa-chart-line"></i> Total P&L</div>
                    <div class="metric-value">${{ metrics.total_pnl|round(2) }}</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-label"><i class="fas fa-percentage"></i> Win Rate</div>
                    <div class="metric-value">{{ metrics.win_rate|round(1) }}%</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-label"><i class="fas fa-arrow-down"></i> Max Drawdown</div>
                    <div class="metric-value">{{ metrics.max_drawdown|round(2) }}%</div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-4">
                <div class="metric-card">
                    <div class="metric-label"><i class="fas fa-exchange-alt"></i> Total Trades</div>
                    <div class="metric-value">{{ metrics.total_trades }}</div>
                    <div class="metric-change">{{ metrics.daily_trades }} today</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="metric-card">
                    <div class="metric-label"><i class="fas fa-calculator"></i> Profit Factor</div>
                    <div class="metric-value">{{ metrics.profit_factor|round(2) }}</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="metric-card">
                    <div class="metric-label"><i class="fas fa-layer-group"></i> Open Positions</div>
                    <div class="metric-value">{{ metrics.positions_open }}</div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <div class="metric-card">
                    <h5><i class="fas fa-atom"></i> Quantum Signals Analysis</h5>
                    <div class="quantum-indicators">
                        <div class="quantum-indicator">
                            <div class="metric-label">Total Signals</div>
                            <div class="metric-value" style="font-size: 1.5rem;">{{ metrics.quantum_signals.total }}</div>
                        </div>
                        <div class="quantum-indicator">
                            <div class="metric-label">Buy Signals</div>
                            <div class="metric-value" style="font-size: 1.5rem; color: #28a745;">{{ metrics.quantum_signals.buy }}</div>
                        </div>
                        <div class="quantum-indicator">
                            <div class="metric-label">Sell Signals</div>
                            <div class="metric-value" style="font-size: 1.5rem; color: #dc3545;">{{ metrics.quantum_signals.sell }}</div>
                        </div>
                        <div class="quantum-indicator">
                            <div class="metric-label">Avg Entropy</div>
                            <div class="metric-value" style="font-size: 1.5rem; color: #6f42c1;">{{ metrics.quantum_signals.avg_entropy|round(3) }}</div>
                        </div>
                        <div class="quantum-indicator">
                            <div class="metric-label">Avg Spin</div>
                            <div class="metric-value" style="font-size: 1.5rem; color: #fd7e14;">{{ metrics.quantum_signals.avg_spin|round(3) }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Link diagnostica -->
        <div class="row">
            <div class="col-12 text-center mb-4">
                <a href="/diagnostics" class="btn btn-primary btn-lg"><i class="fas fa-tools"></i> Vai alla Diagnostica (Motivi Blocco &amp; Segnali)</a>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6">
                <div class="chart-container">
                    <div id="pnl_chart"></div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <div id="drawdown_chart"></div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6">
                <div class="chart-container">
                    <div id="balance_chart"></div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <div id="hourly_chart"></div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6">
                <div class="chart-container">
                    <div id="symbols_chart"></div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <div id="signals_chart"></div>
                </div>
            </div>
        </div>
        <div class="last-update">
            <i class="fas fa-clock"></i> Last updated: {{ last_update }}
        </div>
        <footer class="text-center mt-4 mb-2" style="color:#888; font-size:0.95rem;">
            THE5ERS Dashboard Legacy &bull; v2.0 &bull; Powered by Phoenix Quantum MonoFX
        </footer>
    </div>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script>
        // Forza il tema dark per tutti i grafici
        function applyDarkTheme(layout) {
            if (!layout) layout = {};
            layout.template = 'plotly_dark';
            return layout;
        }

        function renderPlotlyChart(divId, chartData, chartLayout) {
            try {
                if (!chartData || chartData.length === 0 || (chartData.length === 1 && chartData[0].y && chartData[0].y.length === 1 && chartData[0].y[0] === 0)) {
                    document.getElementById(divId).innerHTML = '<div class="loading-spinner">Nessun dato disponibile per questo grafico.</div>';
                    return;
                }
                Plotly.newPlot(divId, chartData, chartLayout, {responsive: true});
            } catch (e) {
                document.getElementById(divId).innerHTML = '<div class="loading-spinner">Errore rendering grafico.</div>';
            }
        }

        var pnlLayout = applyDarkTheme(JSON.parse(`{{ pnl_chart.layout|default({})|tojson|safe }}`));
        var drawdownLayout = applyDarkTheme(JSON.parse(`{{ drawdown_chart.layout|default({})|tojson|safe }}`));
        var balanceLayout = applyDarkTheme(JSON.parse(`{{ balance_chart.layout|default({})|tojson|safe }}`));
        var hourlyLayout = applyDarkTheme(JSON.parse(`{{ hourly_chart.layout|default({})|tojson|safe }}`));
        var symbolsLayout = applyDarkTheme(JSON.parse(`{{ symbols_chart.layout|default({})|tojson|safe }}`));
        var signalsLayout = applyDarkTheme(JSON.parse(`{{ signals_chart.layout|default({})|tojson|safe }}`));

        var pnlData = JSON.parse(`{{ pnl_chart.data|tojson|safe }}`);
        var drawdownData = JSON.parse(`{{ drawdown_chart.data|tojson|safe }}`);
        var balanceData = JSON.parse(`{{ balance_chart.data|tojson|safe }}`);
        var hourlyData = JSON.parse(`{{ hourly_chart.data|tojson|safe }}`);
        var symbolsData = JSON.parse(`{{ symbols_chart.data|tojson|safe }}`);
        var signalsData = JSON.parse(`{{ signals_chart.data|tojson|safe }}`);

        renderPlotlyChart('pnl_chart', pnlData, pnlLayout);
        renderPlotlyChart('drawdown_chart', drawdownData, drawdownLayout);
        renderPlotlyChart('balance_chart', balanceData, balanceLayout);
        renderPlotlyChart('hourly_chart', hourlyData, hourlyLayout);
        renderPlotlyChart('symbols_chart', symbolsData, symbolsLayout);
        renderPlotlyChart('signals_chart', signalsData, signalsLayout);
    </script>
</body>

</html>
